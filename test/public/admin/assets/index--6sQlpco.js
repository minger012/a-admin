var Z=Object.defineProperty;var U=Object.getOwnPropertySymbols;var ee=Object.prototype.hasOwnProperty,te=Object.prototype.propertyIsEnumerable;var L=(t,a,s)=>a in t?Z(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s,q=(t,a)=>{for(var s in a||(a={}))ee.call(a,s)&&L(t,s,a[s]);if(U)for(var s of U(a))te.call(a,s)&&L(t,s,a[s]);return t};var R=(t,a,s)=>new Promise((x,v)=>{var _=p=>{try{w(s.next(p))}catch(f){v(f)}},b=p=>{try{w(s.throw(p))}catch(f){v(f)}},w=p=>p.done?x(p.value):Promise.resolve(p.value).then(_,b);w((s=s.apply(t,a)).next())});import{B as ne}from"./Table-BxPYim8H.js";import{T as oe}from"./TableAction-BhlWyVlW.js";import{_ as ae}from"./BasicForm-QjO4c9-O.js";import{u as le}from"./useForm-BHF_BjGC.js";import{s as $,v as se,A as C,d as ie,u as re,p as ue,r as g,b as B,x as I,w as o,q as pe,o as z,j as n,h as y,i as c,z as de,C as me,N as ce,B as _e,D as fe,F as ge,G as ye,l as ve,k as be,_ as we,E as he}from"./index--W9FB2Si.js";import{P as ke}from"./PlusOutlined-DRSj6shY.js";import"./vuedraggable.umd-B1pj_Zeo.js";import"./useDesignSetting-BH2ledVX.js";import"./propTypes-DHDRA3s2.js";import"./componentSetting-CQq0JJwW.js";import"./index-Tz6qLsBu.js";import"./DownOutlined-CqNoZsnt.js";const M=[{label:"全部",value:""},{label:"系统公告",value:1},{label:"系统维护",value:2},{label:"活动通知",value:3}],Te={1:{text:"系统公告",type:"info"},2:{text:"系统维护",type:"warning"},3:{text:"活动通知",type:"success"}};function xe(t){const a=Te[t]||{text:"未知",type:"default"};return $(se,{type:a.type,bordered:!1},{default:()=>a.text})}const De=[{title:"ID",key:"id",width:80},{title:"用户ID",key:"uid",width:100},{title:"通知类型",key:"type",width:120,render(t){return xe(t.type)}},{title:"通知标题",key:"title",width:200,ellipsis:{tooltip:!0}},{title:"通知内容",key:"content",width:300,ellipsis:{tooltip:!0}},{title:"阅读时间",key:"read_time",width:180,render(t){return t.read_time?new Date(t.read_time*1e3).toLocaleString():"未读"}},{title:"更新时间",key:"update_time",width:180,render(t){return t.update_time?new Date(t.update_time*1e3).toLocaleString():"-"}},{title:"创建时间",key:"create_time",width:180,render(t){return t.create_time?new Date(t.create_time*1e3).toLocaleString():"-"}}];function Re(t){return C.Post("/admin/mail/list",t,{meta:{isReturnNativeResponse:!0}})}function Ce(t){return C.Post("/admin/mail/send",t,{meta:{isReturnNativeResponse:!0}})}function Ne(t){return C.Post("/admin/mail/del",{id:t},{meta:{isReturnNativeResponse:!0}})}const Ve=ie({__name:"index",setup(t){const a=re(),s=ue(),x=g(),v=g(),_=g(!1),b=g(!1),w=g(!1),p=g([]),f=g({}),l=B({sendType:1,uids:[],type:1,title:"",content:""}),A={sendType:{required:!0,type:"number",message:"请选择发送类型",trigger:["change"]},uids:{required:!0,type:"array",message:"请选择用户",trigger:["change"],validator:(u,e)=>l.sendType===2&&(!e||e.length===0)?new Error("请至少选择一个用户"):!0},type:{required:!0,type:"number",message:"请选择通知类型",trigger:["change"]},title:{required:!0,message:"请输入通知标题",trigger:["blur","input"]},content:{required:!0,message:"请输入通知内容",trigger:["blur","input"]}},O=[{field:"uid",component:"NInput",label:"用户ID",componentProps:{placeholder:"请输入用户ID"}},{field:"type",component:"NSelect",label:"通知类型",componentProps:{placeholder:"请选择通知类型",options:M},slot:"typeSlot"},{field:"timeRange",component:"NDatePicker",label:"创建时间",componentProps:{type:"daterange",clearable:!0,shortcuts:{一周内:[Date.now()-7*24*60*60*1e3,Date.now()],一个月内:[Date.now()-30*24*60*60*1e3,Date.now()],三个月内:[Date.now()-90*24*60*60*1e3,Date.now()]}}}],[F]=le({gridProps:{cols:"1 s:1 m:2 l:3 xl:4 2xl:4"},labelWidth:100,schemas:O});function V(h){return R(this,arguments,function*({page:u,pageSize:e}){const d=q({page:String(u),pageSize:String(e)},f.value);d.timeRange&&d.timeRange.length===2&&(d.sTime=Math.floor(d.timeRange[0]/1e3),d.eTime=Math.floor(d.timeRange[1]/1e3),delete d.timeRange);try{const r=(yield Re(d)).data;return r.userList&&r.userList.length>0&&(p.value=r.userList.map(m=>({label:`${m.username} (ID: ${m.id})`,value:m.id}))),{list:r.list||[],page:Number(r.page)||1,pageCount:Number(r.total_page)||0,pageSize:Number(r.page_size)||10,itemCount:Number(r.total)||0}}catch(k){return a.error("获取通知列表失败"),{list:[],page:1,pageCount:0,pageSize:10,itemCount:0}}})}function D(){x.value.reload()}function j(){Object.assign(l,{sendType:1,uids:[],type:1,title:"",content:""}),_.value=!0}function E(){return R(this,null,function*(){var u;try{yield(u=v.value)==null?void 0:u.validate(),b.value=!0;const e={sendType:l.sendType,type:l.type,title:l.title,content:l.content};l.sendType===2&&(e.uids=l.uids);const h=yield Ce(e);h.code===1?(a.success("通知发送成功"),_.value=!1,D()):a.error(h.msg||"通知发送失败")}catch(e){console.error("表单提交错误:",e)}finally{b.value=!1}})}function G(u){f.value=u,D()}function W(){f.value={},D()}const H=B({width:150,title:"操作",key:"action",fixed:"right",render(u){return $(oe,{style:"button",actions:[{label:"删除",type:"error",onClick:J.bind(null,u)}]})}});function J(u){s.warning({title:"确认删除",content:"确定要删除这条通知吗？",positiveText:"确定",negativeText:"取消",onPositiveClick:()=>R(this,null,function*(){try{const e=yield Ne(u.id);e.code===1?(a.success("删除成功"),D()):a.error(e.msg||"删除失败")}catch(e){console.error("删除失败:",e),a.error("删除失败，请重试")}})})}return(u,e)=>{const h=me,d=ce,k=_e,r=fe,m=ge,N=ye,T=ve,S=be,K=we,Q=he,X=pe;return z(),I(X,{bordered:!1,class:"proCard"},{default:o(()=>[n(y(ae),{onRegister:y(F),onSubmit:G,onReset:W},{typeSlot:o(({model:i,field:P})=>[n(h,{value:i[P],"onUpdate:value":Y=>i[P]=Y,options:y(M)},null,8,["value","onUpdate:value","options"])]),_:1},8,["onRegister"]),n(y(ne),{columns:y(De),request:V,"row-key":i=>i.id,ref_key:"actionRef",ref:x,actionColumn:H,"scroll-x":1400,striped:!0},{tableTitle:o(()=>[n(r,null,{default:o(()=>[n(k,{type:"primary",onClick:j},{icon:o(()=>[n(d,null,{default:o(()=>[n(y(ke))]),_:1})]),default:o(()=>[e[7]||(e[7]=c(" 发送通知 "))]),_:1})]),_:1})]),_:1},8,["columns","row-key","actionColumn"]),n(Q,{show:_.value,"onUpdate:show":e[6]||(e[6]=i=>_.value=i),"show-icon":!1,preset:"dialog",title:"发送通知",style:{width:"700px"}},{action:o(()=>[n(r,null,{default:o(()=>[n(k,{onClick:e[5]||(e[5]=()=>_.value=!1)},{default:o(()=>e[13]||(e[13]=[c("取消")])),_:1}),n(k,{type:"primary",loading:b.value,onClick:E},{default:o(()=>e[14]||(e[14]=[c(" 发送 ")])),_:1},8,["loading"])]),_:1})]),default:o(()=>[n(K,{model:l,rules:A,ref_key:"formRef",ref:v,"label-placement":"left","label-width":120,class:"py-4"},{default:o(()=>[n(T,{label:"发送类型",path:"sendType"},{default:o(()=>[n(N,{value:l.sendType,"onUpdate:value":e[0]||(e[0]=i=>l.sendType=i)},{default:o(()=>[n(r,null,{default:o(()=>[n(m,{value:1},{default:o(()=>e[8]||(e[8]=[c("发送所有用户")])),_:1}),n(m,{value:2},{default:o(()=>e[9]||(e[9]=[c("发送指定用户")])),_:1})]),_:1})]),_:1},8,["value"])]),_:1}),l.sendType===2?(z(),I(T,{key:0,label:"选择用户",path:"uids"},{default:o(()=>[n(h,{value:l.uids,"onUpdate:value":e[1]||(e[1]=i=>l.uids=i),options:p.value,multiple:"",filterable:"",placeholder:"请选择用户",loading:w.value},null,8,["value","options","loading"])]),_:1})):de("",!0),n(T,{label:"通知类型",path:"type"},{default:o(()=>[n(N,{value:l.type,"onUpdate:value":e[2]||(e[2]=i=>l.type=i)},{default:o(()=>[n(r,null,{default:o(()=>[n(m,{value:1},{default:o(()=>e[10]||(e[10]=[c("系统公告")])),_:1}),n(m,{value:2},{default:o(()=>e[11]||(e[11]=[c("系统维护")])),_:1}),n(m,{value:3},{default:o(()=>e[12]||(e[12]=[c("活动通知")])),_:1})]),_:1})]),_:1},8,["value"])]),_:1}),n(T,{label:"通知标题",path:"title"},{default:o(()=>[n(S,{placeholder:"请输入通知标题",value:l.title,"onUpdate:value":e[3]||(e[3]=i=>l.title=i),maxlength:"100","show-count":""},null,8,["value"])]),_:1}),n(T,{label:"通知内容",path:"content"},{default:o(()=>[n(S,{type:"textarea",placeholder:"请输入通知内容",value:l.content,"onUpdate:value":e[4]||(e[4]=i=>l.content=i),autosize:{minRows:4,maxRows:8},maxlength:"500","show-count":""},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show"])]),_:1})}}});export{Ve as default};
