var J=Object.defineProperty;var C=Object.getOwnPropertySymbols;var K=Object.prototype.hasOwnProperty,Q=Object.prototype.propertyIsEnumerable;var P=(n,l,s)=>l in n?J(n,l,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[l]=s,U=(n,l)=>{for(var s in l||(l={}))K.call(l,s)&&P(n,s,l[s]);if(C)for(var s of C(l))Q.call(l,s)&&P(n,s,l[s]);return n};var D=(n,l,s)=>new Promise((k,m)=>{var v=u=>{try{g(s.next(u))}catch(a){m(a)}},R=u=>{try{g(s.throw(u))}catch(a){m(a)}},g=u=>u.done?k(u.value):Promise.resolve(u.value).then(v,R);g((s=s.apply(n,l)).next())});import{B as X}from"./Table-BsfMaboV.js";import{s as Y,v as Z,A as I,d as ee,u as te,r as f,b as ne,x as L,w as o,q as oe,o as q,j as t,h as y,i as c,z as ae,C as le,N as se,B as ie,D as re,F as ue,G as pe,l as de,k as me,_ as _e,E as ce}from"./index-C4bwFPRU.js";import{_ as fe}from"./BasicForm-CLt3-8U8.js";import{u as ge}from"./useForm-CXmAmMFN.js";import{P as ye}from"./PlusOutlined-CFr5I1d4.js";import"./vuedraggable.umd-DcUfH-TH.js";import"./useDesignSetting-DbD-gdTl.js";import"./propTypes-CjHlpx3C.js";import"./componentSetting-CQq0JJwW.js";import"./index-CsSSQVOk.js";import"./DownOutlined-DA6TRB-L.js";const B=[{label:"全部",value:""},{label:"系统公告",value:1},{label:"系统维护",value:2},{label:"活动通知",value:3}],ve={1:{text:"系统公告",type:"info"},2:{text:"系统维护",type:"warning"},3:{text:"活动通知",type:"success"}};function be(n){const l=ve[n]||{text:"未知",type:"default"};return Y(Z,{type:l.type,bordered:!1},{default:()=>l.text})}const we=[{title:"ID",key:"id",width:80},{title:"用户ID",key:"uid",width:100},{title:"通知类型",key:"type",width:120,render(n){return be(n.type)}},{title:"通知标题",key:"title",width:200,ellipsis:{tooltip:!0}},{title:"通知内容",key:"content",width:300,ellipsis:{tooltip:!0}},{title:"阅读时间",key:"read_time",width:180,render(n){return n.read_time?new Date(n.read_time*1e3).toLocaleString():"未读"}},{title:"更新时间",key:"update_time",width:180,render(n){return n.update_time?new Date(n.update_time*1e3).toLocaleString():"-"}},{title:"创建时间",key:"create_time",width:180,render(n){return n.create_time?new Date(n.create_time*1e3).toLocaleString():"-"}}];function he(n){return I.Post("/admin/mail/list",n,{meta:{isReturnNativeResponse:!0}})}function ke(n){return I.Post("/admin/mail/send",n,{meta:{isReturnNativeResponse:!0}})}const Ie=ee({__name:"index",setup(n){const l=te(),s=f(),k=f(),m=f(!1),v=f(!1),R=f(!1),g=f([]),u=f({}),a=ne({sendType:1,uids:[],type:1,title:"",content:""}),z={sendType:{required:!0,type:"number",message:"请选择发送类型",trigger:["change"]},uids:{required:!0,type:"array",message:"请选择用户",trigger:["change"],validator:(_,e)=>a.sendType===2&&(!e||e.length===0)?new Error("请至少选择一个用户"):!0},type:{required:!0,type:"number",message:"请选择通知类型",trigger:["change"]},title:{required:!0,message:"请输入通知标题",trigger:["blur","input"]},content:{required:!0,message:"请输入通知内容",trigger:["blur","input"]}},M=[{field:"uid",component:"NInput",label:"用户ID",componentProps:{placeholder:"请输入用户ID"}},{field:"type",component:"NSelect",label:"通知类型",componentProps:{placeholder:"请选择通知类型",options:B},slot:"typeSlot"},{field:"timeRange",component:"NDatePicker",label:"创建时间",componentProps:{type:"daterange",clearable:!0,shortcuts:{一周内:[Date.now()-7*24*60*60*1e3,Date.now()],一个月内:[Date.now()-30*24*60*60*1e3,Date.now()],三个月内:[Date.now()-90*24*60*60*1e3,Date.now()]}}}],[$]=ge({gridProps:{cols:"1 s:1 m:2 l:3 xl:4 2xl:4"},labelWidth:100,schemas:M});function O(b){return D(this,arguments,function*({page:_,pageSize:e}){const p=U({page:String(_),pageSize:String(e)},u.value);p.timeRange&&p.timeRange.length===2&&(p.sTime=Math.floor(p.timeRange[0]/1e3),p.eTime=Math.floor(p.timeRange[1]/1e3),delete p.timeRange);try{const r=(yield he(p)).data;return r.userList&&r.userList.length>0&&(g.value=r.userList.map(d=>({label:`${d.username} (ID: ${d.id})`,value:d.id}))),{list:r.list||[],page:Number(r.page)||1,pageCount:Number(r.total_page)||0,pageSize:Number(r.page_size)||10,itemCount:Number(r.total)||0}}catch(w){return l.error("获取通知列表失败"),{list:[],page:1,pageCount:0,pageSize:10,itemCount:0}}})}function x(){s.value.reload()}function A(){Object.assign(a,{sendType:1,uids:[],type:1,title:"",content:""}),m.value=!0}function F(){return D(this,null,function*(){var _;try{yield(_=k.value)==null?void 0:_.validate(),v.value=!0;const e={sendType:a.sendType,type:a.type,title:a.title,content:a.content};a.sendType===2&&(e.uids=a.uids);const b=yield ke(e);b.code===1?(l.success("通知发送成功"),m.value=!1,x()):l.error(b.msg||"通知发送失败")}catch(e){console.error("表单提交错误:",e)}finally{v.value=!1}})}function V(_){u.value=_,x()}function j(){u.value={},x()}return(_,e)=>{const b=le,p=se,w=ie,r=re,d=ue,T=pe,h=de,N=me,E=_e,G=ce,W=oe;return q(),L(W,{bordered:!1,class:"proCard"},{default:o(()=>[t(y(fe),{onRegister:y($),onSubmit:V,onReset:j},{typeSlot:o(({model:i,field:S})=>[t(b,{value:i[S],"onUpdate:value":H=>i[S]=H,options:y(B)},null,8,["value","onUpdate:value","options"])]),_:1},8,["onRegister"]),t(y(X),{columns:y(we),request:O,"row-key":i=>i.id,ref_key:"actionRef",ref:s,"scroll-x":1400,striped:!0},{tableTitle:o(()=>[t(r,null,{default:o(()=>[t(w,{type:"primary",onClick:A},{icon:o(()=>[t(p,null,{default:o(()=>[t(y(ye))]),_:1})]),default:o(()=>[e[7]||(e[7]=c(" 发送通知 "))]),_:1})]),_:1})]),_:1},8,["columns","row-key"]),t(G,{show:m.value,"onUpdate:show":e[6]||(e[6]=i=>m.value=i),"show-icon":!1,preset:"dialog",title:"发送通知",style:{width:"700px"}},{action:o(()=>[t(r,null,{default:o(()=>[t(w,{onClick:e[5]||(e[5]=()=>m.value=!1)},{default:o(()=>e[13]||(e[13]=[c("取消")])),_:1}),t(w,{type:"primary",loading:v.value,onClick:F},{default:o(()=>e[14]||(e[14]=[c(" 发送 ")])),_:1},8,["loading"])]),_:1})]),default:o(()=>[t(E,{model:a,rules:z,ref_key:"formRef",ref:k,"label-placement":"left","label-width":120,class:"py-4"},{default:o(()=>[t(h,{label:"发送类型",path:"sendType"},{default:o(()=>[t(T,{value:a.sendType,"onUpdate:value":e[0]||(e[0]=i=>a.sendType=i)},{default:o(()=>[t(r,null,{default:o(()=>[t(d,{value:1},{default:o(()=>e[8]||(e[8]=[c("发送所有用户")])),_:1}),t(d,{value:2},{default:o(()=>e[9]||(e[9]=[c("发送指定用户")])),_:1})]),_:1})]),_:1},8,["value"])]),_:1}),a.sendType===2?(q(),L(h,{key:0,label:"选择用户",path:"uids"},{default:o(()=>[t(b,{value:a.uids,"onUpdate:value":e[1]||(e[1]=i=>a.uids=i),options:g.value,multiple:"",filterable:"",placeholder:"请选择用户",loading:R.value},null,8,["value","options","loading"])]),_:1})):ae("",!0),t(h,{label:"通知类型",path:"type"},{default:o(()=>[t(T,{value:a.type,"onUpdate:value":e[2]||(e[2]=i=>a.type=i)},{default:o(()=>[t(r,null,{default:o(()=>[t(d,{value:1},{default:o(()=>e[10]||(e[10]=[c("系统公告")])),_:1}),t(d,{value:2},{default:o(()=>e[11]||(e[11]=[c("系统维护")])),_:1}),t(d,{value:3},{default:o(()=>e[12]||(e[12]=[c("活动通知")])),_:1})]),_:1})]),_:1},8,["value"])]),_:1}),t(h,{label:"通知标题",path:"title"},{default:o(()=>[t(N,{placeholder:"请输入通知标题",value:a.title,"onUpdate:value":e[3]||(e[3]=i=>a.title=i),maxlength:"100","show-count":""},null,8,["value"])]),_:1}),t(h,{label:"通知内容",path:"content"},{default:o(()=>[t(N,{type:"textarea",placeholder:"请输入通知内容",value:a.content,"onUpdate:value":e[4]||(e[4]=i=>a.content=i),autosize:{minRows:4,maxRows:8},maxlength:"500","show-count":""},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show"])]),_:1})}}});export{Ie as default};
