var Y=Object.defineProperty;var N=Object.getOwnPropertySymbols;var Z=Object.prototype.hasOwnProperty,ee=Object.prototype.propertyIsEnumerable;var P=(t,o,n)=>o in t?Y(t,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[o]=n,R=(t,o)=>{for(var n in o||(o={}))Z.call(o,n)&&P(t,n,o[n]);if(N)for(var n of N(o))ee.call(o,n)&&P(t,n,o[n]);return t};var k=(t,o,n)=>new Promise((b,_)=>{var v=u=>{try{f(n.next(u))}catch(y){_(y)}},d=u=>{try{f(n.throw(u))}catch(y){_(y)}},f=u=>u.done?b(u.value):Promise.resolve(u.value).then(v,d);f((n=n.apply(t,o)).next())});import{B as te}from"./Table-B7zsuUw9.js";import{s as oe,v as ne,A as z,d as ae,u as le,r as w,b as se,x as T,w as a,q as re,o as S,j as r,h as g,i as h,c as ie,y as ue,z as B,C as ce,N as de,B as pe,D as me,k as _e,l as fe,_ as ge,E as we}from"./index-BEDOAs2M.js";import{_ as ve}from"./BasicForm-DYjcmFKt.js";import{u as ye}from"./useForm-nNaFm5KP.js";import{u as x,w as he}from"./xlsx-DaVhO591.js";import{P as be}from"./PlusOutlined-DnK2ELqe.js";import{D as ke}from"./DownloadOutlined-B_HUG7fM.js";import"./vuedraggable.umd-Dy6826IL.js";import"./useDesignSetting-OypQRMnc.js";import"./propTypes-C2D30ETy.js";import"./componentSetting-CQq0JJwW.js";import"./index-BWiplwgM.js";import"./DownOutlined-jyipYFFO.js";const De=[{type:"selection"},{title:"ID",key:"id",width:80},{title:"授权码",key:"code",width:150},{title:"状态",key:"state",width:100,render(t){return oe(ne,{type:t.state===0?"info":"success",bordered:!1},{default:()=>t.state===0?"未使用":"已使用"})}},{title:"所属管理者",key:"username",width:150},{title:"更新时间",key:"update_time",width:180,render(t){return t.update_time?new Date(t.update_time*1e3).toLocaleString():""}},{title:"创建时间",key:"create_time",width:180,render(t){return t.create_time?new Date(t.create_time*1e3).toLocaleString():""}}],M=[{label:"全部",value:""},{label:"未使用",value:0},{label:"已使用",value:1}];function L(t){return z.Post("/admin/code/list",t,{meta:{isReturnNativeResponse:!0}})}function Re(t){return z.Post("/admin/code/add",t,{meta:{isReturnNativeResponse:!0}})}const Se={key:0,class:"text-gray-500"},Ie=ae({__name:"index",setup(t){const o=le(),n=w(),b=w(),_=w(!1),v=w(!1),d=w([]),f=w({}),u=se({code:""}),y={code:{required:!0,message:"请生成授权码",trigger:["blur","input"]}},A=[{field:"state",component:"NSelect",label:"状态",componentProps:{placeholder:"请选择状态",options:M,clearable:!0},slot:"statusSlot"},{field:"username",component:"NInput",label:"所属管理者",componentProps:{placeholder:"请输入所属管理者"}},{field:"timeRange",component:"NDatePicker",label:"创建时间",componentProps:{type:"daterange",clearable:!0,shortcuts:{一周内:[Date.now()-7*24*60*60*1e3,Date.now()],一个月内:[Date.now()-30*24*60*60*1e3,Date.now()],三个月内:[Date.now()-90*24*60*60*1e3,Date.now()]}}}],[U]=ye({gridProps:{cols:"1 s:1 m:2 l:3 xl:4 2xl:4"},labelWidth:100,schemas:A});function $(c){return k(this,arguments,function*({page:l,pageSize:e}){const i=R({page:String(l),pageSize:String(e)},f.value);i.timeRange&&i.timeRange.length===2&&(i.sTime=Math.floor(i.timeRange[0]/1e3),i.eTime=Math.floor(i.timeRange[1]/1e3),delete i.timeRange);try{const s=(yield L(i)).data;return{list:s.list||[],page:Number(s.page)||1,pageCount:Number(s.total_page)||0,pageSize:Number(s.page_size)||10,itemCount:Number(s.total)||0}}catch(m){return o.error("获取授权码列表失败"),{list:[],page:1,pageCount:0,pageSize:10,itemCount:0}}})}function D(){n.value.reload()}function E(){let l="";for(let e=0;e<8;e++)l+=Math.floor(Math.random()*10).toString();return l}function F(){u.code=E(),_.value=!0}function I(l){return k(this,null,function*(){var e;l.preventDefault(),v.value=!0;try{yield(e=b.value)==null?void 0:e.validate();const c=yield Re({code:u.code});c.code===1?(o.success("添加成功"),_.value=!1,D()):o.error(c.msg||"添加失败")}catch(c){console.error("表单提交错误:",c),o.error("表单验证失败，请检查输入")}finally{v.value=!1}})}function q(l){f.value=l,D()}function O(){D()}function V(){d.value=[]}function j(){return k(this,null,function*(){let l=[];if(d.value.length>0)l=n.value.getDataSource().filter(c=>d.value.includes(c.id));else try{const e=R({page:"1",pageSize:"999999"},f.value);e.timeRange&&e.timeRange.length===2&&(e.sTime=Math.floor(e.timeRange[0]/1e3),e.eTime=Math.floor(e.timeRange[1]/1e3),delete e.timeRange),l=(yield L(e)).data.list||[]}catch(e){o.error("获取数据失败");return}if(l.length===0){o.warning("没有数据可导出");return}K(l)})}function K(l){const e=l.map(s=>({ID:s.id,授权码:s.code,状态:s.state===0?"未使用":"已使用",所属管理者:s.username||"-",更新时间:s.update_time?new Date(s.update_time*1e3).toLocaleString():"",创建时间:s.create_time?new Date(s.create_time*1e3).toLocaleString():""})),c=x.json_to_sheet(e),i=x.book_new();x.book_append_sheet(i,c,"授权码列表");const m=`授权码列表_${new Date().toLocaleDateString().replace(/\//g,"-")}.xlsx`;he(i,m),o.success(`导出成功，共 ${l.length} 条数据`)}return(l,e)=>{const c=ce,i=de,m=pe,s=me,W=_e,G=fe,H=ge,J=we,Q=re;return S(),T(Q,{bordered:!1,class:"proCard"},{default:a(()=>[r(g(ve),{onRegister:g(U),onSubmit:q,onReset:O},{statusSlot:a(({model:p,field:C})=>[r(c,{value:p[C],"onUpdate:value":X=>p[C]=X,options:g(M)},null,8,["value","onUpdate:value","options"])]),_:1},8,["onRegister"]),r(g(te),{columns:g(De),request:$,"row-key":p=>p.id,ref_key:"actionRef",ref:n,"scroll-x":1200,striped:!0,"checked-row-keys":d.value,"onUpdate:checkedRowKeys":e[0]||(e[0]=p=>d.value=p)},{tableTitle:a(()=>[r(s,{class:"flex items-center"},{default:a(()=>[r(m,{type:"primary",onClick:F},{icon:a(()=>[r(i,null,{default:a(()=>[r(g(be))]),_:1})]),default:a(()=>[e[4]||(e[4]=h(" 新增授权码 "))]),_:1}),r(m,{onClick:j},{icon:a(()=>[r(i,null,{default:a(()=>[r(g(ke))]),_:1})]),default:a(()=>[e[5]||(e[5]=h(" 导出 "))]),_:1}),d.value.length>0?(S(),ie("span",Se," 已选 "+ue(d.value.length)+" 项 ",1)):B("",!0),d.value.length>0?(S(),T(m,{key:1,text:"",type:"primary",onClick:V},{default:a(()=>e[6]||(e[6]=[h(" 清除 ")])),_:1})):B("",!0)]),_:1})]),_:1},8,["columns","row-key","checked-row-keys"]),r(J,{show:_.value,"onUpdate:show":e[3]||(e[3]=p=>_.value=p),"show-icon":!1,preset:"dialog",title:"新增授权码",style:{width:"500px"}},{action:a(()=>[r(s,null,{default:a(()=>[r(m,{onClick:e[2]||(e[2]=()=>_.value=!1)},{default:a(()=>e[7]||(e[7]=[h("取消")])),_:1}),r(m,{type:"info",loading:v.value,onClick:I},{default:a(()=>e[8]||(e[8]=[h(" 确定 ")])),_:1},8,["loading"])]),_:1})]),default:a(()=>[r(H,{model:u,rules:y,ref_key:"formRef",ref:b,"label-placement":"left","label-width":120,class:"py-4"},{default:a(()=>[r(G,{label:"授权码",path:"code"},{default:a(()=>[r(W,{placeholder:"自动生成的授权码",value:u.code,"onUpdate:value":e[1]||(e[1]=p=>u.code=p),disabled:""},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show"])]),_:1})}}});export{Ie as default};
