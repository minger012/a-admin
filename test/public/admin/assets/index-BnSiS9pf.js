var we=Object.defineProperty;var M=Object.getOwnPropertySymbols;var ke=Object.prototype.hasOwnProperty,xe=Object.prototype.propertyIsEnumerable;var F=(s,f,l)=>f in s?we(s,f,{enumerable:!0,configurable:!0,writable:!0,value:l}):s[f]=l,j=(s,f)=>{for(var l in f||(f={}))ke.call(f,l)&&F(s,l,f[l]);if(M)for(var l of M(f))xe.call(f,l)&&F(s,l,f[l]);return s};var O=(s,f,l)=>new Promise((R,x)=>{var S=g=>{try{m(l.next(g))}catch(v){x(v)}},C=g=>{try{m(l.throw(g))}catch(v){x(v)}},m=g=>g.done?R(g.value):Promise.resolve(g.value).then(S,C);m((l=l.apply(s,f)).next())});import{B as Ce}from"./Table-yWmXchEz.js";import{T as De}from"./TableAction-DEAt9_Pl.js";import{_ as Re}from"./BasicForm-GOTDwX7A.js";import{u as Se}from"./useForm-DHO36Kak.js";import{g as Ue}from"./goods-4WM9oFYY.js";import{d as K,u as W,r as b,aa as q,t as Pe,o as X,x as H,C as Q,n as Te,s as p,v as Ie,a0 as Ne,ab as Oe,ac as Ae,p as Be,b as J,w as o,q as Ee,j as a,h as u,B as k,N as U,i as P,y as $e,k as D,D as ze,l as Le,ad as Ve,$ as Me,_ as Fe,E as je}from"./index-BUaCiTCS.js";import{a as qe,p as Je,b as Ge,c as Ke}from"./plan-XBSWO05t.js";import{P as B}from"./PlusOutlined-C1XCBWs4.js";import{D as z}from"./DeleteOutlined-C4VDLv2p.js";import"./vuedraggable.umd-DngLu4Z2.js";import"./useDesignSetting-IaSTxNx8.js";import"./propTypes-CzR-Mwfa.js";import"./componentSetting-CQq0JJwW.js";import"./index-CEAvHuK6.js";import"./DownOutlined-oqXgzy95.js";const We=K({__name:"index",props:{value:{type:[Number,String],default:null},placeholder:{type:String,default:"请选择产品"},disabled:{type:Boolean,default:!1}},emits:["update:value","change"],setup(s,{emit:f}){const l=s,R=f,x=W(),S=b(!1),C=b([]),m=b(l.value);q(()=>l.value,d=>{m.value=d}),q(()=>m.value,d=>{R("update:value",d),R("change",d)}),Pe(()=>{g()});function g(d=""){return O(this,null,function*(){S.value=!0;try{const w={page:"1",pageSize:"100"};d&&(w.name=d);const T=yield Ue(w);if(T.code===1){const I=T.data.list||[];if(C.value=I.map(y=>({label:`${y.name} (ID: ${y.id})`,value:y.id})),m.value&&!C.value.some(y=>y.value===m.value)){const y=I.find(E=>E.id===m.value);y&&C.value.unshift({label:`${y.name} (ID: ${y.id})`,value:y.id})}}else x.error("获取产品列表失败")}catch(w){console.error("加载产品列表错误:",w),x.error("获取产品列表失败")}finally{S.value=!1}})}function v(d){d&&g(d)}function n(d){m.value=d}return(d,w)=>{const T=Q;return X(),H(T,{value:m.value,"onUpdate:value":[w[0]||(w[0]=I=>m.value=I),n],filterable:"",remote:"",loading:S.value,options:C.value,placeholder:s.placeholder,onSearch:v},null,8,["value","loading","options","placeholder"])}}}),Xe=Te(We,[["__scopeId","data-v-0d25b483"]]),G=[{label:"未激活",value:0},{label:"激活",value:1},{label:"结束",value:2}],He=[{title:"ID",key:"id",width:80},{title:"计划名称",key:"name",width:150},{title:"计划编号",key:"number",width:150},{title:"产品ID",key:"goods_id",width:100},{title:"状态",key:"state",width:100,render(s){const l={0:{type:"warning",text:"暂停"},1:{type:"success",text:"激活"},2:{type:"error",text:"结束"}}[s.state]||{type:"default",text:"未知"};return p(Ie,{type:l.type,size:"small"},{default:()=>l.text})}},{title:"简介",key:"intro",width:200,ellipsis:{tooltip:!0}},{title:"主图",key:"image",width:100,render(s){return s.image?p(Ne,{width:60,height:60,src:s.image,objectFit:"cover",showToolbarTooltip:!0}):"无图片"}},{title:"创建时间",key:"create_time",width:150,render(s){return new Date(s.create_time*1e3).toLocaleString()}},{title:"更新时间",key:"update_time",width:150,render(s){return s.update_time?new Date(s.update_time*1e3).toLocaleString():"-"}}],mt=K({__name:"index",setup(s){const{VITE_GLOB_API_URL_PREFIX:f}=Oe(),l=W(),R=b(),x=b(),S=Ae(),C=Be(),m=b(!1),g=b(!1),v=b(!1),n=J({id:0,name:"",goods_id:null,intro:"",image:"",content:[],orienteering:[],rule:[],state:0}),d=b([]),w=[{title:"标题",key:"title",render:(t,e)=>p(D,{value:t.title,onUpdateValue:r=>{n.content||(n.content=[]),n.content[e].title=r},placeholder:"请输入标题"})},{title:"内容",key:"content",render:(t,e)=>p(D,{value:t.content,onUpdateValue:r=>{n.content||(n.content=[]),n.content[e].content=r},placeholder:"请输入内容"})},{title:"操作",key:"actions",width:100,render:(t,e)=>p("div",{class:"flex space-x-2"},p(k,{text:!0,type:"error",onClick:()=>se(e)},{icon:()=>p(U,null,{default:()=>p(z)})}))}],T=[{title:"标题",key:"title",render:(t,e)=>p(D,{value:t.title,onUpdateValue:r=>{n.orienteering||(n.orienteering=[]),n.orienteering[e].title=r},placeholder:"请输入标题"})},{title:"内容",key:"content",render:(t,e)=>p(D,{value:t.content,onUpdateValue:r=>{n.orienteering||(n.orienteering=[]),n.orienteering[e].content=r},placeholder:"请输入内容"})},{title:"操作",key:"actions",width:100,render:(t,e)=>p("div",{class:"flex space-x-2"},p(k,{text:!0,type:"error",onClick:()=>de(e)},{icon:()=>p(U,null,{default:()=>p(z)})}))}],I=[{title:"标题",key:"title",render:(t,e)=>p(D,{value:t.title,onUpdateValue:r=>{n.rule||(n.rule=[]),n.rule[e].title=r},placeholder:"请输入标题"})},{title:"内容",key:"content",render:(t,e)=>p(D,{value:t.content,onUpdateValue:r=>{n.rule||(n.rule=[]),n.rule[e].content=r},placeholder:"请输入内容"})},{title:"操作",key:"actions",width:100,render:(t,e)=>p("div",{class:"flex space-x-2"},p(k,{text:!0,type:"error",onClick:()=>pe(e)},{icon:()=>p(U,null,{default:()=>p(z)})}))}],y={name:{required:!0,trigger:["blur","input"],message:"请输入计划名称"},goods_id:{required:!0,trigger:["blur","change"],validator:(t,e)=>e==null||e===""?new Error("请选择产品"):!0},image:{required:!0,trigger:["blur","change"],message:"请上传主图"}},E=[{field:"id",component:"NInput",label:"计划ID",componentProps:{placeholder:""}},{field:"state",component:"NSelect",label:"状态",componentProps:{placeholder:"请选择",options:G},slot:"statusSlot"},{field:"timeRange",component:"NDatePicker",label:"创建时间",componentProps:{type:"daterange",clearable:!0,shortcuts:{一周内:[Date.now()-7*24*60*60*1e3,Date.now()],一个月内:[Date.now()-30*24*60*60*1e3,Date.now()],三个月内:[Date.now()-90*24*60*60*1e3,Date.now()]}}}],Y=J({width:150,title:"操作",key:"action",fixed:"right",render(t){return p(De,{style:"button",actions:[{label:"修改",type:"primary",onClick:fe.bind(null,t)},{label:"删除",type:"error",onClick:e=>{e.stopPropagation(),C.warning({title:"确定删除吗？",content:"删除后将无法恢复",positiveText:"确定",negativeText:"取消",onPositiveClick:()=>{ge(t)}})}}]})}}),L=b({}),[Z]=Se({gridProps:{cols:"1 s:1 m:2 l:3 xl:4 2xl:4"},labelWidth:80,schemas:E});function ee(){Object.assign(n,{id:0,name:"",goods_id:null,intro:"",image:"",content:[],orienteering:[],rule:[],state:0}),d.value=[],m.value=!0}function te(r){return O(this,arguments,function*({page:t,pageSize:e}){const i=j({page:String(t),pageSize:String(e)},L.value);i.timeRange&&i.timeRange.length===2&&(i.sTime=Math.floor(i.timeRange[0]/1e3),i.eTime=Math.floor(i.timeRange[1]/1e3),delete i.timeRange);try{const h=(yield Je(i)).data;return{page:h.page,pageSize:h.page_size,pageCount:h.total_page,itemCount:h.total,list:h.list||[]}}catch(c){return l.error("获取计划列表失败"),{list:[],page:1,pageCount:0,pageSize:10,itemCount:0}}})}function ne(t){console.log(t)}function N(){R.value.reload()}const ae=t=>{const{file:e}=t;return e.file?["image/jpeg","image/png","image/gif"].includes(e.file.type)?e.file.size>2*1024*1024?(l.error("图片大小不能超过2MB"),!1):(v.value=!0,!0):(l.error("只能上传jpg/png/gif格式的图片"),!1):!1},le=t=>{const{file:e,event:r}=t;try{const i=JSON.parse(r.target.response);if(i.code===1)e.url=i.data.url,n.image=i.data.url,l.success("上传成功");else{l.error("上传失败: "+i.msg||"未知错误");const c=d.value.findIndex(h=>h.id===e.id);c!==-1&&d.value.splice(c,1)}}catch(i){console.error("上传响应解析错误:",i),l.error("上传失败");const c=d.value.findIndex(h=>h.id===e.id);c!==-1&&d.value.splice(c,1)}finally{v.value=!1}},oe=()=>{l.error("上传失败"),v.value=!1},ie=()=>{n.image="",d.value=[]},re=()=>{n.content||(n.content=[]),n.content.push({title:"",content:""})},se=t=>{n.content.splice(t,1)},ue=()=>{n.orienteering||(n.orienteering=[]),n.orienteering.push({title:"",content:""})},de=t=>{n.orienteering.splice(t,1)},ce=()=>{n.rule||(n.rule=[]),n.rule.push({title:"",content:""})},pe=t=>{n.rule.splice(t,1)};function me(t){return O(this,null,function*(){t.preventDefault(),g.value=!0,setTimeout(()=>O(this,null,function*(){var e;try{yield(e=x.value)==null?void 0:e.validate();const r={id:n.id,name:n.name,goods_id:n.goods_id,intro:n.intro,image:n.image,content:n.content||[],orienteering:n.orienteering||[],rule:n.rule||[],state:n.state};if(n.id){const i=yield Ge(r);i.code===1?(l.success("修改成功"),m.value=!1,N()):l.error(i.msg||"修改失败")}else{const i=yield Ke(r);i.code===1?(l.success("添加成功"),m.value=!1,N()):l.error(i.msg||"添加失败")}}catch(r){console.error("表单提交错误:",r),l.error("表单验证失败，请检查输入")}finally{g.value=!1}}),0)})}function fe(t){let e=[],r=[],i=[];try{e=Array.isArray(t.content)?t.content:typeof t.content=="string"?JSON.parse(t.content):[]}catch(c){console.error("解析content失败:",c)}try{r=Array.isArray(t.orienteering)?t.orienteering:typeof t.orienteering=="string"?JSON.parse(t.orienteering):[]}catch(c){console.error("解析orienteering失败:",c)}try{i=Array.isArray(t.rule)?t.rule:typeof t.rule=="string"?JSON.parse(t.rule):[]}catch(c){console.error("解析rule失败:",c)}Object.assign(n,{id:t.id,name:t.name,goods_id:t.goods_id,intro:t.intro||"",image:t.image||"",content:e,orienteering:r,rule:i,state:t.state!==void 0?t.state:0}),d.value=t.image?[{id:"1",name:"主图",status:"finished",url:t.image}]:[],m.value=!0}function ge(t){l.info("正在删除..."),qe(t.id).then(e=>{e.code===1?(l.success("删除成功"),N()):l.error(e.msg||"删除失败")})}function _e(t){L.value=t,N()}function ve(){N()}return(t,e)=>{const r=Q,i=ze,c=Le,h=Ve,$=Me,A=Ee,ye=Fe,he=je;return X(),H(A,{bordered:!1,class:"proCard"},{default:o(()=>[a(u(Re),{onRegister:u(Z),onSubmit:_e,onReset:ve},{statusSlot:o(({model:_,field:V})=>[a(r,{value:_[V],"onUpdate:value":be=>_[V]=be,options:u(G)},null,8,["value","onUpdate:value","options"])]),_:1},8,["onRegister"]),a(u(Ce),{columns:u(He),request:te,"row-key":_=>_.id,ref_key:"actionRef",ref:R,actionColumn:Y,"onUpdate:checkedRowKeys":ne,"scroll-x":1200,striped:!0},{tableTitle:o(()=>[a(i,null,{default:o(()=>[a(u(k),{type:"primary",onClick:ee},{icon:o(()=>[a(u(U),null,{default:o(()=>[a(u(B))]),_:1})]),default:o(()=>[e[6]||(e[6]=P(" 新增计划 "))]),_:1})]),_:1})]),_:1},8,["columns","row-key","actionColumn"]),a(he,{show:m.value,"onUpdate:show":e[5]||(e[5]=_=>m.value=_),"show-icon":!1,preset:"dialog",title:n.id?"编辑计划":"新增计划",style:{width:"700px"}},{action:o(()=>[a(i,null,{default:o(()=>[a(u(k),{onClick:e[4]||(e[4]=()=>m.value=!1),disabled:v.value},{default:o(()=>e[11]||(e[11]=[P("取消")])),_:1},8,["disabled"]),a(u(k),{type:"info",loading:g.value,disabled:v.value,onClick:me},{default:o(()=>[P($e(v.value?"图片上传中...":"确定"),1)]),_:1},8,["loading","disabled"])]),_:1})]),default:o(()=>[a(ye,{model:n,rules:y,ref_key:"formRef",ref:x,"label-placement":"left","label-width":120,class:"py-4"},{default:o(()=>[a(c,{label:"计划名称",path:"name"},{default:o(()=>[a(u(D),{placeholder:"请输入计划名称",value:n.name,"onUpdate:value":e[0]||(e[0]=_=>n.name=_)},null,8,["value"])]),_:1}),a(c,{label:"产品",path:"goods_id"},{default:o(()=>[a(Xe,{value:n.goods_id,"onUpdate:value":e[1]||(e[1]=_=>n.goods_id=_),placeholder:"请选择产品"},null,8,["value"])]),_:1}),a(c,{label:"计划简介",path:"intro"},{default:o(()=>[a(u(D),{type:"textarea",placeholder:"请输入计划简介",value:n.intro,"onUpdate:value":e[2]||(e[2]=_=>n.intro=_),autosize:{minRows:3,maxRows:5}},null,8,["value"])]),_:1}),a(c,{label:"主图",path:"image"},{default:o(()=>[a(h,{action:u(f)+"/admin/file/uploadImage","default-file-list":d.value,"list-type":"image-card",max:1,"on-before-upload":ae,name:"image",headers:{Authorization:u(S).getToken},onFinish:le,onError:oe,onRemove:ie},{default:o(()=>e[7]||(e[7]=[P(" 上传主图 ")])),_:1},8,["action","default-file-list","headers"])]),_:1}),a(c,{label:"投放内容",path:"content"},{default:o(()=>[a(A,null,{default:o(()=>[a(i,{vertical:""},{default:o(()=>[a(u(k),{type:"primary",onClick:re},{icon:o(()=>[a(u(U),null,{default:o(()=>[a(u(B))]),_:1})]),default:o(()=>[e[8]||(e[8]=P(" 添加内容 "))]),_:1}),a($,{columns:w,data:n.content||[],pagination:!1,bordered:!0},null,8,["data"])]),_:1})]),_:1})]),_:1}),a(c,{label:"用户定向规则",path:"orienteering"},{default:o(()=>[a(A,null,{default:o(()=>[a(i,{vertical:""},{default:o(()=>[a(u(k),{type:"primary",onClick:ue},{icon:o(()=>[a(u(U),null,{default:o(()=>[a(u(B))]),_:1})]),default:o(()=>[e[9]||(e[9]=P(" 添加规则 "))]),_:1}),a($,{columns:T,data:n.orienteering||[],pagination:!1,bordered:!0},null,8,["data"])]),_:1})]),_:1})]),_:1}),a(c,{label:"投放规则",path:"rule"},{default:o(()=>[a(A,null,{default:o(()=>[a(i,{vertical:""},{default:o(()=>[a(u(k),{type:"primary",onClick:ce},{icon:o(()=>[a(u(U),null,{default:o(()=>[a(u(B))]),_:1})]),default:o(()=>[e[10]||(e[10]=P(" 添加规则 "))]),_:1}),a($,{columns:I,data:n.rule||[],pagination:!1,bordered:!0},null,8,["data"])]),_:1})]),_:1})]),_:1}),a(c,{label:"状态",path:"state"},{default:o(()=>[a(r,{value:n.state,"onUpdate:value":e[3]||(e[3]=_=>n.state=_),options:[{label:"暂停",value:0},{label:"激活",value:1}],placeholder:"请选择状态"},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"])]),_:1})}}});export{mt as default};
