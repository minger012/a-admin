var ve=Object.defineProperty;var $=Object.getOwnPropertySymbols;var be=Object.prototype.hasOwnProperty,he=Object.prototype.propertyIsEnumerable;var j=(m,g,n)=>g in m?ve(m,g,{enumerable:!0,configurable:!0,writable:!0,value:n}):m[g]=n,V=(m,g)=>{for(var n in g||(g={}))be.call(g,n)&&j(m,n,g[n]);if($)for(var n of $(g))he.call(g,n)&&j(m,n,g[n]);return m};var U=(m,g,n)=>new Promise((S,D)=>{var I=f=>{try{_(n.next(f))}catch(w){D(w)}},E=f=>{try{_(n.throw(f))}catch(w){D(w)}},_=f=>f.done?S(f.value):Promise.resolve(f.value).then(I,E);_((n=n.apply(m,g)).next())});import{B as ke}from"./Table-B7zsuUw9.js";import{T as we}from"./TableAction-DB_awGjd.js";import{_ as xe}from"./BasicForm-DYjcmFKt.js";import{u as De}from"./useForm-nNaFm5KP.js";import{f as M}from"./dateUtil-DeXksHIp.js";import{s as y,v as Ce,a0 as G,d as Te,ab as Se,u as Ae,r as b,ac as Re,p as Ue,b as K,c as X,j as o,w as l,X as Ie,q as Le,o as F,h as p,B as x,N as L,i as h,y as J,z as W,x as Ee,k,D as Fe,l as Ne,C as Pe,ad as ze,$ as Be,U as qe,_ as Oe,E as $e}from"./index-BEDOAs2M.js";import{a as je,g as H,b as Ve,c as Me}from"./goods-HFr5FWlt.js";import{u as N,w as Ge}from"./xlsx-DaVhO591.js";import{P as Q}from"./PlusOutlined-DnK2ELqe.js";import{D as Ke}from"./DownloadOutlined-B_HUG7fM.js";import{D as Xe}from"./DeleteOutlined-BFnMVw_N.js";import"./vuedraggable.umd-Dy6826IL.js";import"./useDesignSetting-OypQRMnc.js";import"./propTypes-C2D30ETy.js";import"./componentSetting-CQq0JJwW.js";import"./index-BWiplwgM.js";import"./DownOutlined-jyipYFFO.js";const Je=[{label:"未生效",value:0},{label:"生效",value:1},{label:"审核中",value:2},{label:"封禁",value:3}],We={0:"未生效",1:"生效",2:"审核中",3:"封禁"},He=[{type:"selection"},{title:"ID",key:"id",width:100},{title:"产品名称",key:"name",width:200},{title:"状态",key:"state",render(m){return y(Ce,{type:m.state==1?"success":m.state==2?"primary":"error",round:!0},()=>We[m.state])},width:120},{title:"简介",key:"intro",width:200},{title:"Logo",key:"logo",render(m){return y(G,{width:50,height:50,src:m.logo,objectFit:"cover",showToolbarTooltip:!0})},width:120},{title:"图片",key:"image",render(m){return y(G,{width:50,height:50,src:m.image&&m.image[0],objectFit:"cover",showToolbarTooltip:!0})},width:120},{title:"创建时间",key:"create_time",width:160,render(m){return m.create_time?M(Number(m.create_time)*1e3):"-"}},{title:"更新时间",key:"update_time",width:160,render(m){return m.update_time?M(Number(m.update_time)*1e3):"-"}}],Qe={key:0,class:"text-gray-500"},_t=Te({__name:"index",setup(m){const{VITE_GLOB_API_URL_PREFIX:g}=Se(),n=Ae(),S=b(),D=b(),I=Re(),E=Ue(),_=b([]),f=b(!1),w=b(!1),C=b(!1),a=K({id:0,name:"",company:"",type_name:"",category:"",intro:"",logo:"",image:[],google_play:"",app_store:"",app_info:[],sort:0,state:1,is_hot:0,is_home:0}),v=b([]),T=b([]),Y=[{title:"标题",key:"title",render:(t,e)=>y(k,{value:t.title,onUpdateValue:i=>{a.app_info||(a.app_info=[]),a.app_info[e].title=i},placeholder:"请输入标题"})},{title:"内容",key:"content",render:(t,e)=>y(k,{value:t.content,onUpdateValue:i=>{a.app_info||(a.app_info=[]),a.app_info[e].content=i},placeholder:"请输入内容"})},{title:"操作",key:"actions",width:100,render:(t,e)=>y("div",{class:"flex space-x-2"},y(x,{text:!0,type:"error",onClick:()=>ie(e)},{icon:()=>y(L,null,{default:()=>y(Xe)})}))}],Z={name:{required:!0,trigger:["blur","input"],message:"请输入产品名称"},company:{required:!0,trigger:["blur","input"],message:"请输入公司名称"},type_name:{required:!0,trigger:["blur","input"],message:"请输入产品类型名称"},intro:{required:!0,trigger:["blur","input"],message:"请输入产品简介"},logo:{required:!0,trigger:["blur","change"],message:"请上传Logo"},image:{required:!0,trigger:["blur","change"],validator:(t,e)=>!e||Array.isArray(e)&&e.length===0?new Error("请上传产品图片"):!0},state:{required:!0,type:"number",trigger:["blur","change"],message:"请选择状态"}},ee=[{field:"id",component:"NInput",label:"产品ID",componentProps:{placeholder:""}},{field:"state",component:"NSelect",label:"状态",componentProps:{placeholder:"请选择",options:Je}}],te=K({width:150,title:"操作",key:"action",fixed:"right",render(t){return y(we,{style:"button",actions:[{label:"修改",type:"primary",onClick:re.bind(null,t)},{label:"删除",type:"error",onClick:e=>{e.stopPropagation(),E.warning({title:"确定删除吗？",content:"删除后将无法恢复",positiveText:"确定",negativeText:"取消",onPositiveClick:()=>{ue(t)}})}}]})}}),P=b({}),[ae]=De({gridProps:{cols:"1 s:1 m:2 l:3 xl:4 2xl:4"},labelWidth:80,schemas:ee});function oe(){Object.assign(a,{id:0,name:"",company:"",type_name:"",category:"",intro:"",logo:"",image:[],google_play:"",app_store:"",app_info:[],sort:0,state:1,is_hot:0,is_home:0}),v.value=[],T.value=[],f.value=!0}function le(i){return U(this,arguments,function*({page:t,pageSize:e}){const d=V({page:String(t),pageSize:String(e)},P.value);try{const r=(yield H(d)).data;return{page:r.page,pageSize:r.page_size,pageCount:r.total_page,itemCount:r.total,list:r.list||[]}}catch(u){return n.error("获取产品列表失败"),{list:[],page:1,pageCount:0,pageSize:10,itemCount:0}}})}function A(){S.value.reload()}const z=(t,e="image")=>{const{file:i}=t;return i.file?["image/jpeg","image/png","image/gif"].includes(i.file.type)?i.file.size>2*1024*1024?(n.error("图片大小不能超过2MB"),!1):(C.value=!0,!0):(n.error("只能上传jpg/png/gif格式的图片"),!1):!1},B=(t,e="image")=>{const{file:i,event:d}=t;try{const u=JSON.parse(d.target.response);if(u.code===1)i.url=u.data.url,e==="image"?(Array.isArray(a.image)||(a.image=[]),a.image.push(u.data.url)):a[e]=u.data.url,n.success("上传成功"),setTimeout(()=>{var r;(r=D.value)==null||r.validate(c=>{},c=>(c==null?void 0:c.key)===e)},100);else{n.error("上传失败: "+u.msg||"未知错误");const r=e==="image"?v:T,c=r.value.findIndex(R=>R.id===i.id);c!==-1&&r.value.splice(c,1)}}catch(u){console.error("上传响应解析错误:",u),n.error("上传失败");const r=e==="image"?v:T,c=r.value.findIndex(R=>R.id===i.id);c!==-1&&r.value.splice(c,1)}finally{C.value=!1}},q=()=>{n.error("上传失败"),C.value=!1},O=(t,e="image")=>{const{file:i}=t;if(e==="image"){if(Array.isArray(a.image)&&i.url){const u=a.image.indexOf(i.url);u>-1&&a.image.splice(u,1)}const d=v.value.findIndex(u=>u.id===i.id);d>-1&&v.value.splice(d,1)}else a[e]="",T.value=[]},ne=()=>{a.app_info||(a.app_info=[]),a.app_info.push({title:"",content:""})},ie=t=>{a.app_info.splice(t,1)};function se(t){return U(this,null,function*(){t.preventDefault(),w.value=!0,setTimeout(()=>U(this,null,function*(){var e;try{yield(e=D.value)==null?void 0:e.validate();const i={id:a.id,name:a.name,company:a.company,type_name:a.type_name,category:a.category,intro:a.intro,logo:a.logo,image:a.image,google_play:a.google_play,app_store:a.app_store,app_info:a.app_info,sort:a.sort,state:a.state,is_hot:a.is_hot,is_home:a.is_home};if(a.id){const d=yield Ve(i);d.code===1?(n.success("修改成功"),f.value=!1,A()):n.error(d.msg||"修改失败")}else{const d=yield Me(i);d.code===1?(n.success("添加成功"),f.value=!1,A()):n.error(d.msg||"添加失败")}}catch(i){console.error("表单提交错误:",i),n.error("表单验证失败，请检查输入")}finally{w.value=!1}}),0)})}function re(t){Object.assign(a,{id:t.id,name:t.name,company:t.company||"",type_name:t.type_name||"",category:t.category||"",intro:t.intro||"",logo:t.logo||"",image:Array.isArray(t.image)?t.image:t.image?[t.image]:[],google_play:t.google_play||"",app_store:t.app_store||"",app_info:t.app_info||[],sort:t.sort||0,state:t.state!==void 0?t.state:1,is_hot:t.is_hot||0,is_home:t.is_home||0}),t.image?Array.isArray(t.image)?v.value=t.image.map((e,i)=>({id:String(i+1),name:`产品图片${i+1}`,status:"finished",url:e})):v.value=[{id:"1",name:"产品图片",status:"finished",url:t.image}]:v.value=[],T.value=t.logo?[{id:"2",name:"Logo",status:"finished",url:t.logo}]:[],f.value=!0}function ue(t){n.info("正在删除..."),je({id:t.id}).then(()=>{n.success("删除成功"),A()})}function pe(t){P.value=t,A()}function me(){A()}function de(){_.value=[]}function ge(){return U(this,null,function*(){let t=[];if(_.value.length>0)t=S.value.getDataSource().filter(i=>_.value.includes(i.id));else try{t=(yield H({page:"1",pageSize:"999999"})).data.list||[]}catch(e){n.error("获取数据失败");return}if(t.length===0){n.warning("没有数据可导出");return}fe(t)})}function fe(t){const e=t.map(r=>({ID:r.id,产品名称:r.name,状态:r.state===0?"未生效":r.state===1?"生效":r.state===2?"审核中":"封禁",简介:r.intro||"-",Logo:r.logo||"-",图片:r.image||"-",创建时间:r.create_time?new Date(r.create_time*1e3).toLocaleString():"-",更新时间:r.update_time?new Date(r.update_time*1e3).toLocaleString():"-"})),i=N.json_to_sheet(e),d=N.book_new();N.book_append_sheet(d,i,"产品列表");const u=`产品列表_${new Date().toLocaleDateString().replace(/\//g,"-")}.xlsx`;Ge(d,u),n.success(`导出成功，共 ${t.length} 条数据`)}return(t,e)=>{const i=Le,d=Fe,u=Ne,r=Pe,c=ze,R=Be,ce=qe,_e=Oe,ye=$e;return F(),X(Ie,null,[o(i,{bordered:!1},{default:l(()=>[o(p(xe),{onRegister:p(ae),onSubmit:pe,onReset:me},null,8,["onRegister"])]),_:1}),o(i,{bordered:!1,class:"mt-3"},{default:l(()=>[o(p(ke),{columns:p(He),request:le,"row-key":s=>s.id,ref_key:"actionRef",ref:S,actionColumn:te,"checked-row-keys":_.value,"onUpdate:checkedRowKeys":e[0]||(e[0]=s=>_.value=s),"scroll-x":1200,striped:!0},{tableTitle:l(()=>[o(d,{class:"flex items-center"},{default:l(()=>[o(p(x),{type:"primary",onClick:oe},{icon:l(()=>[o(p(L),null,{default:l(()=>[o(p(Q))]),_:1})]),default:l(()=>[e[15]||(e[15]=h(" 新增产品 "))]),_:1}),o(p(x),{onClick:ge},{icon:l(()=>[o(p(L),null,{default:l(()=>[o(p(Ke))]),_:1})]),default:l(()=>[e[16]||(e[16]=h(" 导出 "))]),_:1}),_.value.length>0?(F(),X("span",Qe," 已选 "+J(_.value.length)+" 项 ",1)):W("",!0),_.value.length>0?(F(),Ee(p(x),{key:1,text:"",type:"primary",onClick:de},{default:l(()=>e[17]||(e[17]=[h(" 清除 ")])),_:1})):W("",!0)]),_:1})]),_:1},8,["columns","row-key","actionColumn","checked-row-keys"]),o(ye,{show:f.value,"onUpdate:show":e[14]||(e[14]=s=>f.value=s),"show-icon":!1,preset:"dialog",title:"编辑产品",style:{width:"700px"}},{action:l(()=>[o(d,null,{default:l(()=>[o(p(x),{onClick:e[13]||(e[13]=()=>f.value=!1),disabled:C.value},{default:l(()=>e[21]||(e[21]=[h("取消")])),_:1},8,["disabled"]),o(p(x),{type:"info",loading:w.value,disabled:C.value,onClick:se},{default:l(()=>[h(J(C.value?"图片上传中...":"确定"),1)]),_:1},8,["loading","disabled"])]),_:1})]),default:l(()=>[o(_e,{model:a,rules:Z,ref_key:"formRef",ref:D,"label-placement":"left","label-width":140,class:"py-4"},{default:l(()=>[o(u,{label:"产品名称",path:"name"},{default:l(()=>[o(p(k),{placeholder:"请输入产品名称",value:a.name,"onUpdate:value":e[1]||(e[1]=s=>a.name=s)},null,8,["value"])]),_:1}),o(u,{label:"产品类型",path:"type_name"},{default:l(()=>[o(p(k),{placeholder:"请输入产品类型",value:a.type_name,"onUpdate:value":e[2]||(e[2]=s=>a.type_name=s)},null,8,["value"])]),_:1}),o(u,{label:"公司",path:"company"},{default:l(()=>[o(p(k),{placeholder:"请输入公司名称",value:a.company,"onUpdate:value":e[3]||(e[3]=s=>a.company=s)},null,8,["value"])]),_:1}),o(u,{label:"简介",path:"intro"},{default:l(()=>[o(p(k),{type:"textarea",placeholder:"请输入产品简介",value:a.intro,"onUpdate:value":e[4]||(e[4]=s=>a.intro=s),autosize:{minRows:3,maxRows:5}},null,8,["value"])]),_:1}),o(u,{label:"状态",path:"state"},{default:l(()=>[o(r,{value:a.state,"onUpdate:value":e[5]||(e[5]=s=>a.state=s),options:[{label:"未生效",value:0},{label:"生效",value:1},{label:"审核中",value:2},{label:"封禁",value:3}],placeholder:"请选择状态"},null,8,["value"])]),_:1}),o(u,{label:"Logo",path:"logo"},{default:l(()=>[o(c,{action:p(g)+"/admin/file/uploadImage","default-file-list":T.value,"list-type":"image-card",max:1,"on-before-upload":s=>z(s,"logo"),name:"image",headers:{Authorization:p(I).getToken},onFinish:e[6]||(e[6]=s=>B(s,"logo")),onError:q,onRemove:e[7]||(e[7]=()=>O("logo"))},{default:l(()=>e[18]||(e[18]=[h(" 上传Logo ")])),_:1},8,["action","default-file-list","on-before-upload","headers"])]),_:1}),o(u,{label:"产品图片",path:"image"},{default:l(()=>[o(c,{action:p(g)+"/admin/file/uploadImage","default-file-list":v.value,"list-type":"image-card",max:9,"on-before-upload":s=>z(s,"image"),name:"image",headers:{Authorization:p(I).getToken},onFinish:e[8]||(e[8]=s=>B(s,"image")),onError:q,onRemove:e[9]||(e[9]=s=>O(s,"image"))},{default:l(()=>e[19]||(e[19]=[h(" 上传产品图片（最多9张） ")])),_:1},8,["action","default-file-list","on-before-upload","headers"])]),_:1}),o(u,{label:"Google Play 链接",path:"google_play"},{default:l(()=>[o(p(k),{placeholder:"请输入",value:a.google_play,"onUpdate:value":e[10]||(e[10]=s=>a.google_play=s)},null,8,["value"])]),_:1}),o(u,{label:"App Store 链接",path:"app_store"},{default:l(()=>[o(p(k),{placeholder:"请输入",value:a.app_store,"onUpdate:value":e[11]||(e[11]=s=>a.app_store=s)},null,8,["value"])]),_:1}),o(u,{label:"应用信息",path:"app_info"},{default:l(()=>[o(d,{vertical:""},{default:l(()=>[o(p(x),{type:"primary",onClick:ne},{icon:l(()=>[o(p(L),null,{default:l(()=>[o(p(Q))]),_:1})]),default:l(()=>[e[20]||(e[20]=h(" 添加信息 "))]),_:1}),o(R,{size:"small",columns:Y,data:a.app_info||[],pagination:!1,bordered:!0},null,8,["data"])]),_:1})]),_:1}),o(u,{label:"排序",path:"sort"},{default:l(()=>[o(ce,{value:a.sort,"onUpdate:value":e[12]||(e[12]=s=>a.sort=s),min:0,placeholder:"请输入排序"},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show"])]),_:1})],64)}}});export{_t as default};
