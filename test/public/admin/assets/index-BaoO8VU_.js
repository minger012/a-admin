var ke=Object.defineProperty;var F=Object.getOwnPropertySymbols;var xe=Object.prototype.hasOwnProperty,Re=Object.prototype.propertyIsEnumerable;var J=(i,f,l)=>f in i?ke(i,f,{enumerable:!0,configurable:!0,writable:!0,value:l}):i[f]=l,j=(i,f)=>{for(var l in f||(f={}))xe.call(f,l)&&J(i,l,f[l]);if(F)for(var l of F(f))Re.call(f,l)&&J(i,l,f[l]);return i};var O=(i,f,l)=>new Promise((S,x)=>{var D=g=>{try{m(l.next(g))}catch(v){x(v)}},R=g=>{try{m(l.throw(g))}catch(v){x(v)}},m=g=>g.done?S(g.value):Promise.resolve(g.value).then(D,R);m((l=l.apply(i,f)).next())});import{B as Ce}from"./Table-BcXbUTxg.js";import{T as Se}from"./TableAction-CTGB6Be_.js";import{_ as De}from"./BasicForm-BufV-4It.js";import{u as Ue}from"./useForm-C7YbISyA.js";import{g as Ne}from"./goods-Bv4FzV1-.js";import{d as W,u as X,r as b,a6 as q,t as Pe,o as H,x as Q,C as Y,n as Ie,s as p,v as Te,a0 as Oe,A as $,a7 as Ae,a8 as Be,p as $e,b as G,w as o,q as Ee,j as a,h as u,B as k,N as U,i as N,y as ze,k as C,D as Le,l as Ve,a9 as Me,$ as Fe,_ as Je,E as je}from"./index-FB6W5mBG.js";import{P as B}from"./PlusOutlined-BWpPOq4g.js";import{D as L}from"./DeleteOutlined-BL3PkYTm.js";import"./vuedraggable.umd-C_5yRcwU.js";import"./useDesignSetting-BvT0Exi7.js";import"./propTypes-j0pcPl7w.js";import"./componentSetting-CQq0JJwW.js";import"./index-BgGIYSO9.js";import"./DownOutlined-BL5GVzwF.js";const qe=W({__name:"index",props:{value:{type:[Number,String],default:null},placeholder:{type:String,default:"请选择产品"},disabled:{type:Boolean,default:!1}},emits:["update:value","change"],setup(i,{emit:f}){const l=i,S=f,x=X(),D=b(!1),R=b([]),m=b(l.value);q(()=>l.value,d=>{m.value=d}),q(()=>m.value,d=>{S("update:value",d),S("change",d)}),Pe(()=>{g()});function g(d=""){return O(this,null,function*(){D.value=!0;try{const w={page:"1",pageSize:"100"};d&&(w.name=d);const P=yield Ne(w);if(P.code===1){const I=P.data.list||[];if(R.value=I.map(y=>({label:`${y.name} (ID: ${y.id})`,value:y.id})),m.value&&!R.value.some(y=>y.value===m.value)){const y=I.find(E=>E.id===m.value);y&&R.value.unshift({label:`${y.name} (ID: ${y.id})`,value:y.id})}}else x.error("获取产品列表失败")}catch(w){console.error("加载产品列表错误:",w),x.error("获取产品列表失败")}finally{D.value=!1}})}function v(d){d&&g(d)}function n(d){m.value=d}return(d,w)=>{const P=Y;return H(),Q(P,{value:m.value,"onUpdate:value":[w[0]||(w[0]=I=>m.value=I),n],filterable:"",remote:"",loading:D.value,options:R.value,placeholder:i.placeholder,onSearch:v},null,8,["value","loading","options","placeholder"])}}}),Ge=Ie(qe,[["__scopeId","data-v-0d25b483"]]),K=[{label:"未激活",value:0},{label:"激活",value:1},{label:"结束",value:2}],Ke=[{title:"ID",key:"id",width:80},{title:"计划名称",key:"name",width:150},{title:"计划编号",key:"number",width:150},{title:"产品ID",key:"goods_id",width:100},{title:"状态",key:"state",width:100,render(i){const l={0:{type:"warning",text:"暂停"},1:{type:"success",text:"激活"},2:{type:"error",text:"结束"}}[i.state]||{type:"default",text:"未知"};return p(Te,{type:l.type,size:"small"},{default:()=>l.text})}},{title:"简介",key:"intro",width:200,ellipsis:{tooltip:!0}},{title:"主图",key:"image",width:100,render(i){return i.image?p(Oe,{width:60,height:60,src:i.image,objectFit:"cover",showToolbarTooltip:!0}):"无图片"}},{title:"创建时间",key:"create_time",width:150,render(i){return new Date(i.create_time*1e3).toLocaleString()}},{title:"更新时间",key:"update_time",width:150,render(i){return i.update_time?new Date(i.update_time*1e3).toLocaleString():"-"}}];function We(i){return $.Post("/admin/plan/list",i,{meta:{isReturnNativeResponse:!0}})}function Xe(i){return $.Post("/admin/plan/add",i,{meta:{isReturnNativeResponse:!0}})}function He(i){return $.Post("/admin/plan/edit",i,{meta:{isReturnNativeResponse:!0}})}function Qe(i){return $.Post("/admin/plan/del",{id:i},{meta:{isReturnNativeResponse:!0}})}const mt=W({__name:"index",setup(i){const{VITE_GLOB_API_URL_PREFIX:f}=Ae(),l=X(),S=b(),x=b(),D=Be(),R=$e(),m=b(!1),g=b(!1),v=b(!1),n=G({id:0,name:"",goods_id:null,intro:"",image:"",content:[],orienteering:[],rule:[],state:0}),d=b([]),w=[{title:"标题",key:"title",render:(t,e)=>p(C,{value:t.title,onUpdateValue:s=>{n.content||(n.content=[]),n.content[e].title=s},placeholder:"请输入标题"})},{title:"内容",key:"content",render:(t,e)=>p(C,{value:t.content,onUpdateValue:s=>{n.content||(n.content=[]),n.content[e].content=s},placeholder:"请输入内容"})},{title:"操作",key:"actions",width:100,render:(t,e)=>p("div",{class:"flex space-x-2"},p(k,{text:!0,type:"error",onClick:()=>ue(e)},{icon:()=>p(U,null,{default:()=>p(L)})}))}],P=[{title:"标题",key:"title",render:(t,e)=>p(C,{value:t.title,onUpdateValue:s=>{n.orienteering||(n.orienteering=[]),n.orienteering[e].title=s},placeholder:"请输入标题"})},{title:"内容",key:"content",render:(t,e)=>p(C,{value:t.content,onUpdateValue:s=>{n.orienteering||(n.orienteering=[]),n.orienteering[e].content=s},placeholder:"请输入内容"})},{title:"操作",key:"actions",width:100,render:(t,e)=>p("div",{class:"flex space-x-2"},p(k,{text:!0,type:"error",onClick:()=>ce(e)},{icon:()=>p(U,null,{default:()=>p(L)})}))}],I=[{title:"标题",key:"title",render:(t,e)=>p(C,{value:t.title,onUpdateValue:s=>{n.rule||(n.rule=[]),n.rule[e].title=s},placeholder:"请输入标题"})},{title:"内容",key:"content",render:(t,e)=>p(C,{value:t.content,onUpdateValue:s=>{n.rule||(n.rule=[]),n.rule[e].content=s},placeholder:"请输入内容"})},{title:"操作",key:"actions",width:100,render:(t,e)=>p("div",{class:"flex space-x-2"},p(k,{text:!0,type:"error",onClick:()=>me(e)},{icon:()=>p(U,null,{default:()=>p(L)})}))}],y={name:{required:!0,trigger:["blur","input"],message:"请输入计划名称"},goods_id:{required:!0,trigger:["blur","input"],message:"请输入产品ID"},image:{required:!0,trigger:["blur","change"],message:"请上传主图"}},E=[{field:"id",component:"NInput",label:"计划ID",componentProps:{placeholder:""}},{field:"state",component:"NSelect",label:"状态",componentProps:{placeholder:"请选择",options:K},slot:"statusSlot"},{field:"timeRange",component:"NDatePicker",label:"创建时间",componentProps:{type:"daterange",clearable:!0,shortcuts:{一周内:[Date.now()-7*24*60*60*1e3,Date.now()],一个月内:[Date.now()-30*24*60*60*1e3,Date.now()],三个月内:[Date.now()-90*24*60*60*1e3,Date.now()]}}}],Z=G({width:150,title:"操作",key:"action",fixed:"right",render(t){return p(Se,{style:"button",actions:[{label:"修改",type:"primary",onClick:ge.bind(null,t)},{label:"删除",type:"error",onClick:e=>{e.stopPropagation(),R.warning({title:"确定删除吗？",content:"删除后将无法恢复",positiveText:"确定",negativeText:"取消",onPositiveClick:()=>{_e(t)}})}}]})}}),V=b({}),[ee]=Ue({gridProps:{cols:"1 s:1 m:2 l:3 xl:4 2xl:4"},labelWidth:80,schemas:E});function te(){Object.assign(n,{id:0,name:"",goods_id:null,intro:"",image:"",content:[],orienteering:[],rule:[],state:0}),d.value=[],m.value=!0}function ne(s){return O(this,arguments,function*({page:t,pageSize:e}){const r=j({page:String(t),pageSize:String(e)},V.value);r.timeRange&&r.timeRange.length===2&&(r.sTime=Math.floor(r.timeRange[0]/1e3),r.eTime=Math.floor(r.timeRange[1]/1e3),delete r.timeRange);try{const h=(yield We(r)).data;return{page:h.page,pageSize:h.page_size,pageCount:h.total_page,itemCount:h.total,list:h.list||[]}}catch(c){return l.error("获取计划列表失败"),{list:[],page:1,pageCount:0,pageSize:10,itemCount:0}}})}function ae(t){console.log(t)}function T(){S.value.reload()}const le=t=>{const{file:e}=t;return e.file?["image/jpeg","image/png","image/gif"].includes(e.file.type)?e.file.size>2*1024*1024?(l.error("图片大小不能超过2MB"),!1):(v.value=!0,!0):(l.error("只能上传jpg/png/gif格式的图片"),!1):!1},oe=t=>{const{file:e,event:s}=t;try{const r=JSON.parse(s.target.response);if(r.code===1)e.url=r.data.url,n.image=r.data.url,l.success("上传成功");else{l.error("上传失败: "+r.msg||"未知错误");const c=d.value.findIndex(h=>h.id===e.id);c!==-1&&d.value.splice(c,1)}}catch(r){console.error("上传响应解析错误:",r),l.error("上传失败");const c=d.value.findIndex(h=>h.id===e.id);c!==-1&&d.value.splice(c,1)}finally{v.value=!1}},ie=()=>{l.error("上传失败"),v.value=!1},re=()=>{n.image="",d.value=[]},se=()=>{n.content||(n.content=[]),n.content.push({title:"",content:""})},ue=t=>{n.content.splice(t,1)},de=()=>{n.orienteering||(n.orienteering=[]),n.orienteering.push({title:"",content:""})},ce=t=>{n.orienteering.splice(t,1)},pe=()=>{n.rule||(n.rule=[]),n.rule.push({title:"",content:""})},me=t=>{n.rule.splice(t,1)};function fe(t){return O(this,null,function*(){t.preventDefault(),g.value=!0,setTimeout(()=>O(this,null,function*(){var e;try{yield(e=x.value)==null?void 0:e.validate();const s={id:n.id,name:n.name,goods_id:n.goods_id,intro:n.intro,image:n.image,content:JSON.stringify(n.content||[]),orienteering:JSON.stringify(n.orienteering||[]),rule:JSON.stringify(n.rule||[]),state:n.state};if(n.id){const r=yield He(s);r.code===1?(l.success("修改成功"),m.value=!1,T()):l.error(r.msg||"修改失败")}else{const r=yield Xe(s);r.code===1?(l.success("添加成功"),m.value=!1,T()):l.error(r.msg||"添加失败")}}catch(s){console.error("表单提交错误:",s),l.error("表单验证失败，请检查输入")}finally{g.value=!1}}),0)})}function ge(t){let e=[],s=[],r=[];try{e=Array.isArray(t.content)?t.content:typeof t.content=="string"?JSON.parse(t.content):[]}catch(c){console.error("解析content失败:",c)}try{s=Array.isArray(t.orienteering)?t.orienteering:typeof t.orienteering=="string"?JSON.parse(t.orienteering):[]}catch(c){console.error("解析orienteering失败:",c)}try{r=Array.isArray(t.rule)?t.rule:typeof t.rule=="string"?JSON.parse(t.rule):[]}catch(c){console.error("解析rule失败:",c)}Object.assign(n,{id:t.id,name:t.name,goods_id:t.goods_id,intro:t.intro||"",image:t.image||"",content:e,orienteering:s,rule:r,state:t.state!==void 0?t.state:0}),d.value=t.image?[{id:"1",name:"主图",status:"finished",url:t.image}]:[],m.value=!0}function _e(t){l.info("正在删除..."),Qe(t.id).then(e=>{e.code===1?(l.success("删除成功"),T()):l.error(e.msg||"删除失败")})}function ve(t){V.value=t,T()}function ye(){T()}return(t,e)=>{const s=Y,r=Le,c=Ve,h=Me,z=Fe,A=Ee,he=Je,be=je;return H(),Q(A,{bordered:!1,class:"proCard"},{default:o(()=>[a(u(De),{onRegister:u(ee),onSubmit:ve,onReset:ye},{statusSlot:o(({model:_,field:M})=>[a(s,{value:_[M],"onUpdate:value":we=>_[M]=we,options:u(K)},null,8,["value","onUpdate:value","options"])]),_:1},8,["onRegister"]),a(u(Ce),{columns:u(Ke),request:ne,"row-key":_=>_.id,ref_key:"actionRef",ref:S,actionColumn:Z,"onUpdate:checkedRowKeys":ae,"scroll-x":1200,striped:!0},{tableTitle:o(()=>[a(r,null,{default:o(()=>[a(u(k),{type:"primary",onClick:te},{icon:o(()=>[a(u(U),null,{default:o(()=>[a(u(B))]),_:1})]),default:o(()=>[e[6]||(e[6]=N(" 新增计划 "))]),_:1})]),_:1})]),_:1},8,["columns","row-key","actionColumn"]),a(be,{show:m.value,"onUpdate:show":e[5]||(e[5]=_=>m.value=_),"show-icon":!1,preset:"dialog",title:n.id?"编辑计划":"新增计划",style:{width:"700px"}},{action:o(()=>[a(r,null,{default:o(()=>[a(u(k),{onClick:e[4]||(e[4]=()=>m.value=!1),disabled:v.value},{default:o(()=>e[11]||(e[11]=[N("取消")])),_:1},8,["disabled"]),a(u(k),{type:"info",loading:g.value,disabled:v.value,onClick:fe},{default:o(()=>[N(ze(v.value?"图片上传中...":"确定"),1)]),_:1},8,["loading","disabled"])]),_:1})]),default:o(()=>[a(he,{model:n,rules:y,ref_key:"formRef",ref:x,"label-placement":"left","label-width":120,class:"py-4"},{default:o(()=>[a(c,{label:"计划名称",path:"name"},{default:o(()=>[a(u(C),{placeholder:"请输入计划名称",value:n.name,"onUpdate:value":e[0]||(e[0]=_=>n.name=_)},null,8,["value"])]),_:1}),a(c,{label:"产品",path:"goods_id"},{default:o(()=>[a(Ge,{value:n.goods_id,"onUpdate:value":e[1]||(e[1]=_=>n.goods_id=_),placeholder:"请选择产品"},null,8,["value"])]),_:1}),a(c,{label:"计划简介",path:"intro"},{default:o(()=>[a(u(C),{type:"textarea",placeholder:"请输入计划简介",value:n.intro,"onUpdate:value":e[2]||(e[2]=_=>n.intro=_),autosize:{minRows:3,maxRows:5}},null,8,["value"])]),_:1}),a(c,{label:"主图",path:"image"},{default:o(()=>[a(h,{action:u(f)+"/admin/file/uploadImage","default-file-list":d.value,"list-type":"image-card",max:1,"on-before-upload":le,name:"image",headers:{Authorization:u(D).getToken},onFinish:oe,onError:ie,onRemove:re},{default:o(()=>e[7]||(e[7]=[N(" 上传主图 ")])),_:1},8,["action","default-file-list","headers"])]),_:1}),a(c,{label:"投放内容",path:"content"},{default:o(()=>[a(A,null,{default:o(()=>[a(r,{vertical:""},{default:o(()=>[a(u(k),{type:"primary",onClick:se},{icon:o(()=>[a(u(U),null,{default:o(()=>[a(u(B))]),_:1})]),default:o(()=>[e[8]||(e[8]=N(" 添加内容 "))]),_:1}),a(z,{columns:w,data:n.content||[],pagination:!1,bordered:!0},null,8,["data"])]),_:1})]),_:1})]),_:1}),a(c,{label:"用户定向规则",path:"orienteering"},{default:o(()=>[a(A,null,{default:o(()=>[a(r,{vertical:""},{default:o(()=>[a(u(k),{type:"primary",onClick:de},{icon:o(()=>[a(u(U),null,{default:o(()=>[a(u(B))]),_:1})]),default:o(()=>[e[9]||(e[9]=N(" 添加规则 "))]),_:1}),a(z,{columns:P,data:n.orienteering||[],pagination:!1,bordered:!0},null,8,["data"])]),_:1})]),_:1})]),_:1}),a(c,{label:"投放规则",path:"rule"},{default:o(()=>[a(A,null,{default:o(()=>[a(r,{vertical:""},{default:o(()=>[a(u(k),{type:"primary",onClick:pe},{icon:o(()=>[a(u(U),null,{default:o(()=>[a(u(B))]),_:1})]),default:o(()=>[e[10]||(e[10]=N(" 添加规则 "))]),_:1}),a(z,{columns:I,data:n.rule||[],pagination:!1,bordered:!0},null,8,["data"])]),_:1})]),_:1})]),_:1}),a(c,{label:"状态",path:"state"},{default:o(()=>[a(s,{value:n.state,"onUpdate:value":e[3]||(e[3]=_=>n.state=_),options:[{label:"暂停",value:0},{label:"激活",value:1}],placeholder:"请选择状态"},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"])]),_:1})}}});export{mt as default};
